#!/usr/bin/python3
import notaol.p3.client
import binascii
import textwrap
import notaol.fdo.stream as fs
import Extras.client_lib as cl
import logging

# Enabling logging.DEBUG will show inbound/outbound packet data
# Setting logging.INFO will show Token detection
logging.basicConfig(level=logging.DEBUG, format='%(levelname)s - %(message)s')

def get_response():
    print("Listening for response.")
    response = sock.recv(8192)
    raw_atom_stream = response[8:-1]
    parsed_atom_stream = parse_atom_stream(raw_atom_stream)
    print(raw_atom_stream)
    print("Parsed:", parsed_atom_stream)


def connect():
    global sock
    sock = cl.connect()
    print("Sending INIT Packet", cl.init_packet)
    sock.send(cl.to_hex(cl.init_packet))
    get_response()

def signon():
    print("Sending Dd", cl.login_packet)
    sock.send(cl.to_hex(cl.login_packet))
    get_response()

def parse_atom_stream(raw_atom_stream):
    atom_stream = fs.AtomStream()
    atom_stream.parse(raw_atom_stream)

def aoshell():
    i = input("reAOL > ")
    if i == "quit":
        exit()
    elif i == "home":
        home_aoshell()
    elif i == "connect":
        connect()
    elif i == "signon":
        # Connect with 2nd arg as username
        signon()
    elif i == "chat":
        join_chat()
    elif i == "commands":
        print_ascii_banner()
        print(
        '''
        pyAOL Client written for re-AOL

        General Commands:
        
        Connect as a Guest:
        reAOL > signon Guest

        Sign Off:
        reAOL > signoff

        List Chat Rooms:
        reAOL > chat list
        reAOL > chat join RoomName
        reAOL > chat leave

        Back to Home:
        reAOL > home

        Quit PyAOL:
        reAOL > quit
        '''
        )
    elif i == "signoff":
        signoff()
    else:
        for a in range(len(i)):
            print(i[a])
    aoshell() 

def signoff():
    sock.send(cl.to_hex(cl.signoff_packet))
    get_response()

def join_chat():
    sock.send(cl.to_hex(cl.join_welcome))
    print(cl.receive_packet(sock))

def home_aoshell():
    print_ascii_banner()
    aoshell()

def print_ascii_banner():
    print(
    '''
             Welcome to:
    '                             d8888   .d88888b.   888
    '                            d88888d 888P"  "Y88b 888
    '                           d88P8888 888      888 888
    '888d888  .d88b.           d88P 8888 888      888 888
    '888 P " 8P  Y8b          d88P  8888 888      888 888
    '888     88888888 888888 d88P   8888 888      888 888
    '888     Y8b.            d8888888888  Y88b. .d88P 888
    '888      "Y8888        d88P     888   "Y88888P"  88888888
                                            generated by: syg

    For more information please visit:       http://reaol.org
    Discord Chat available at:        http://discord.gg/reaol

    Please enter a command at the prompt to begin.
    For a list of commands enter:     commands
    '''
    )
    
if __name__ == "__main__":
    print_ascii_banner()
    aoshell()
